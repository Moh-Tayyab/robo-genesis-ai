# Data Model: BetterAuth Authentication Service

**Feature**: 006-betterauth-service
**Date**: 2025-11-30
**Database**: NeonDB PostgreSQL (separate from personalization DB)

## Entity Relationship Diagram

```
┌─────────────────┐
│      user       │
├─────────────────┤
│ id (PK)         │
│ name            │
│ email (unique)  │
│ emailVerified   │
│ image           │
│ createdAt       │
│ updatedAt       │
└────────┬────────┘
         │
         │ 1:N
         ▼
┌─────────────────┐      ┌─────────────────┐
│    session      │      │    account      │
├─────────────────┤      ├─────────────────┤
│ id (PK)         │      │ id (PK)         │
│ token (unique)  │      │ accountId       │
│ expiresAt       │      │ providerId      │
│ ipAddress       │      │ userId (FK)─────┼──► user.id
│ userAgent       │      │ password        │
│ userId (FK)─────┼──►   │ createdAt       │
│ createdAt       │      │ updatedAt       │
│ updatedAt       │      └─────────────────┘
└─────────────────┘

┌─────────────────┐
│  verification   │
├─────────────────┤
│ id (PK)         │
│ identifier      │
│ value           │
│ expiresAt       │
│ createdAt       │
│ updatedAt       │
└─────────────────┘
```

## Tables

### user

Stores registered user information.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | TEXT | PRIMARY KEY | UUID generated by BetterAuth |
| name | TEXT | NOT NULL | User's display name |
| email | TEXT | NOT NULL, UNIQUE | User's email address |
| emailVerified | BOOLEAN | DEFAULT false, NOT NULL | Whether email is verified |
| image | TEXT | NULLABLE | Profile image URL |
| createdAt | TIMESTAMP | DEFAULT NOW(), NOT NULL | Account creation time |
| updatedAt | TIMESTAMP | DEFAULT NOW(), NOT NULL | Last update time |

**Indexes**:
- Primary key on `id`
- Unique index on `email`

---

### session

Stores active login sessions.

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | TEXT | PRIMARY KEY | Session ID |
| token | TEXT | NOT NULL, UNIQUE | Session token (in cookie) |
| expiresAt | TIMESTAMP | NOT NULL | Session expiration time |
| ipAddress | TEXT | NULLABLE | Client IP address |
| userAgent | TEXT | NULLABLE | Client user agent string |
| userId | TEXT | NOT NULL, FK → user.id | Owner of session |
| createdAt | TIMESTAMP | DEFAULT NOW(), NOT NULL | Session creation time |
| updatedAt | TIMESTAMP | DEFAULT NOW(), NOT NULL | Last activity time |

**Indexes**:
- Primary key on `id`
- Unique index on `token`
- Index on `userId`

**Relationships**:
- `userId` → `user.id` (ON DELETE CASCADE)

---

### account

Stores authentication credentials (password for email/password provider).

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | TEXT | PRIMARY KEY | Account ID |
| accountId | TEXT | NOT NULL | Provider-specific account ID |
| providerId | TEXT | NOT NULL | Auth provider (e.g., "credential") |
| userId | TEXT | NOT NULL, FK → user.id | Owner of account |
| password | TEXT | NULLABLE | Hashed password (bcrypt) |
| createdAt | TIMESTAMP | DEFAULT NOW(), NOT NULL | Account creation time |
| updatedAt | TIMESTAMP | DEFAULT NOW(), NOT NULL | Last update time |

**Indexes**:
- Primary key on `id`
- Index on `userId`

**Relationships**:
- `userId` → `user.id` (ON DELETE CASCADE)

---

### verification

Stores verification tokens for email verification and password reset (future use).

| Column | Type | Constraints | Description |
|--------|------|-------------|-------------|
| id | TEXT | PRIMARY KEY | Verification record ID |
| identifier | TEXT | NOT NULL | What is being verified (email) |
| value | TEXT | NOT NULL | Verification token |
| expiresAt | TIMESTAMP | NOT NULL | Token expiration time |
| createdAt | TIMESTAMP | DEFAULT NOW(), NOT NULL | Record creation time |
| updatedAt | TIMESTAMP | DEFAULT NOW(), NOT NULL | Last update time |

**Indexes**:
- Primary key on `id`

---

## Drizzle Schema

```typescript
// packages/auth-database/schema/auth-schema.ts

import { pgTable, text, timestamp, boolean } from "drizzle-orm/pg-core";

export const user = pgTable("user", {
  id: text("id").primaryKey(),
  name: text("name").notNull(),
  email: text("email").notNull().unique(),
  emailVerified: boolean("email_verified").default(false).notNull(),
  image: text("image"),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at")
    .defaultNow()
    .$onUpdate(() => new Date())
    .notNull(),
});

export const session = pgTable("session", {
  id: text("id").primaryKey(),
  token: text("token").notNull().unique(),
  expiresAt: timestamp("expires_at").notNull(),
  ipAddress: text("ip_address"),
  userAgent: text("user_agent"),
  userId: text("user_id")
    .notNull()
    .references(() => user.id, { onDelete: "cascade" }),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at")
    .defaultNow()
    .$onUpdate(() => new Date())
    .notNull(),
});

export const account = pgTable("account", {
  id: text("id").primaryKey(),
  accountId: text("account_id").notNull(),
  providerId: text("provider_id").notNull(),
  userId: text("user_id")
    .notNull()
    .references(() => user.id, { onDelete: "cascade" }),
  password: text("password"),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at")
    .defaultNow()
    .$onUpdate(() => new Date())
    .notNull(),
});

export const verification = pgTable("verification", {
  id: text("id").primaryKey(),
  identifier: text("identifier").notNull(),
  value: text("value").notNull(),
  expiresAt: timestamp("expires_at").notNull(),
  createdAt: timestamp("created_at").defaultNow().notNull(),
  updatedAt: timestamp("updated_at")
    .defaultNow()
    .$onUpdate(() => new Date())
    .notNull(),
});
```

## Migration

Generate and apply migrations using Drizzle Kit:

```bash
cd packages/auth-database

# Generate migration
pnpm db:generate

# Apply to database
pnpm db:push
```

## Data Flow

### Sign Up Flow
1. User submits name, email, password
2. BetterAuth creates `user` record
3. BetterAuth creates `account` record with hashed password
4. BetterAuth creates `session` record
5. Session token set in cookie

### Sign In Flow
1. User submits email, password
2. BetterAuth looks up `account` by email (via `user`)
3. BetterAuth verifies password hash
4. BetterAuth creates new `session` record
5. Session token set in cookie

### Session Validation Flow
1. Client sends request with session cookie
2. BetterAuth looks up `session` by token
3. BetterAuth checks `expiresAt` > now
4. BetterAuth returns user info from `user` table

### Sign Out Flow
1. Client calls sign out endpoint
2. BetterAuth deletes `session` record
3. Cookie cleared

## Security Considerations

1. **Password Storage**: BetterAuth uses bcrypt for password hashing
2. **Session Tokens**: Cryptographically random, stored securely
3. **Cascade Delete**: Deleting user removes all sessions and accounts
4. **Token Expiration**: Sessions expire after 7 days by default
5. **No Plaintext**: Password field stores only hashed values
